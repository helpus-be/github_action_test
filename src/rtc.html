<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRtc tutorial</title>
  </head>

  <body>
    <div>
      <input id="userId" type="number" placeholder="userId" required />
      <button id="login">login</button>
    </div>
    <div>
      ownerId <input id="ownerId" type="number" /> <br /><br />
      postId <input id="postId" type="number" /> <br /><br />
      senderId <input id="senderId" type="number" /> <br /><br />
      roomId <input id="roomId" type="text" /> <br /><br />
      <!-- 채팅 내용 입력 -->
      <input id="chat" type="text" />
      <!-- join 이벤트 발생시키는 버튼 -->
      <button id="room1">채팅방1 입장</button>
      <!-- send 이벤트 발생시키는 버튼 -->
      <button id="room1-send">채팅방1 에서 채팅</button>
      <button id="login">login</button>
      <button id="start-videocall">화상통화 시작하기</button>
    </div>

    <div>
      <ul id="chat-history">
        <!-- 여기에 방 입장시 이전 채팅내역이 추가됩니다. -->
      </ul>
      <ul id="real-time-chat">
        <!-- 여기에 실시간 채팅 내역이 추가됩니다. -->
      </ul>
    </div>

    <br />
    <div style="border: solid 1px black">
      <video id="myFace" width="480px" height="480px" autoplay playsinline></video>
      <video id="yourFace" width="480px" height="480px" autoplay playsinline></video>
    </div>
    <br />
    <div><button id="mute">음소거</button><button id="camera">카메라 끄기</button></div>

    <script src="http://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
      const socket = io('ws://localhost:3001');
      const myFace = document.getElementById('myFace');
      const startVideo = document.getElementById('start-videocall');

      let myStream;
      let roomId;
      let myPeerConnection = new RTCPeerConnection();

      // 로그인
      $('#login').click(() => {
        socket.emit('login', $('#userId').val());
      });

      // 방 입장 이벤트 전달
      $('#room1').click(async () => {
        await socket.emit('join', {
          senderId: $('#senderId').val(),
          ownerId: $('#userId').val(),
          postId: $('#postId').val(),
        });
      });

      $('#room1-send').click(() => {
        if (roomId !== '')
          socket.emit('send', {
            content: $('#chat').val(),
            roomId: $('#roomId').val(),
            userId: $('#userId').val(),
            postId: $('#postId').val(),
          });
      });
      // 카메라, 오디오 접근을 허용하고 송출
      async function getMedia() {
        try {
          myStream = await navigator.mediaDevices.getUserMedia({
            audio: false,
            video: true,
          });

          myFace.srcObject = myStream;
        } catch (error) {
          console.log(error);
        }
      }

      // 1. getMedia
      // 2. makeConnection
      // 3. startVideo

      // 채팅을 하다가 화상통화 시작 버튼을 누르면 오퍼를 생성 offer : 초대장같은거라고 생각하면 됨
      // Peer A 인 브라우저에서 실행
      // Peer A 는 offer를 생성한다.
      // setLocalDescription 을 실행하고 Peer B 에게 offer 를 보낸다.

      async function initCall() {
        await getMedia();
        makeConnection();
      }

      $('#start-videocall').click(async () => {
        await initCall();
        socket.emit('startVideoCall');
      });

      socket.on('startVideo', async () => {
        const offer = await myPeerConnection.createOffer();
        myPeerConnection.setRemoteDescription(offer);
        myPeerConnection.setLocalDescription(offer);
        socket.emit('offer', offer);
        console.log('sent the offer');
      });

      socket.on('offer', async (offer) => {
        console.log('recieved the offer');
        myPeerConnection.setRemoteDescription(offer);
        const answer = await myPeerConnection.createAnswer();
        myPeerConnection.setLocalDescription(answer);
        socket.emit('answer', answer);
        console.log('sent the answer');
      });

      socket.on('answer', (answer) => {
        console.log('recieved the answer');
        myPeerConnection.setRemoteDescription(answer);
      });

      // broadcast 라는 이벤트를 발생시킴, 채팅
      socket.on('broadcast', (data) => {
        $('#real-time-chat').append(
          `<li>${data.userId} : ${data.content},[ ${data.createdAt}]</li>`
        );
      });

      socket.on('ice', (ice) => {
        console.log('recieved candidate');
        myPeerConnection.addIceCandidate(ice);
      });

      function makeConnection() {
        myStream.getTracks().forEach((track) => {
          myPeerConnection.addTrack(track, myStream);
          myPeerConnection.addEventListener('icecandidate', handleIce);
          myPeerConnection.addEventListener('addstream', handleAddStream);
        });
      }

      function handleIce(data) {
        console.log('sent candidate');
        socket.emit('ice', data.candidate);
      }

      function handleAddStream(data) {
        const yourFace = document.getElementById('yourFace');
        console.log("Peer's Stream : ", data.stream);
        console.log('My Stream : ', myStream);
        yourFace.srcObject = data.stream;
      }
    </script>
  </body>
</html>

<!-- strean 의 데이터를 가져가 연결을 만듦 -->
